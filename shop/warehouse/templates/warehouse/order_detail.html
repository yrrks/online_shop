{% extends "warehouse/base_warehouse.html" %}
{% load static %}

{% block title %}{% if order.order.status == 'done' %}–ó–∞–∫–∞–∑ #{{ order.id }} —Å–æ–±—Ä–∞–Ω{% else %}–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞ #{{ order.id }}{% endif %}{% endblock %}

{% block content %}
<link href="{% static 'warehouse/css/order_detail.css' %}" rel="stylesheet">
<script src="{% static 'warehouse/js/order_detail.js' %}"></script>
<div class="order-detail-container">

    {% if order.order.status == 'done' %}
    <!-- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–±—Ä–∞–Ω -->
    <div class="order-completed-message">
        <div class="completed-icon">‚úÖ</div>
        <h1>–ó–∞–∫–∞–∑ #{{ order.id }} —É–∂–µ —Å–æ–±—Ä–∞–Ω</h1>
        <p>–≠—Ç–æ—Ç –∑–∞–∫–∞–∑ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω —Å–±–æ—Ä—â–∏–∫–æ–º <strong>{{ order.order.picker.username }}</strong></p>
        <div class="completed-actions">
            <a href="{% url 'warehouse:orders_manager' %}" class="btn btn-primary">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑–∞–º –Ω–∞ —Å–±–æ—Ä–∫—É
            </a>
        </div>
    </div>

    {% else %}
    <!-- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –µ—â–µ –Ω–µ —Å–æ–±—Ä–∞–Ω -->
    <div class="order-header">
        <h1>–ó–∞–∫–∞–∑ #{{ order.id }}</h1>
        <div class="order-meta">
            <span class="status-badge status-{{ order.order.status }}">
                {{ order.order.get_status_display }}
            </span>
            <span class="order-date">{{ order.created|date:"d.m.Y H:i" }}</span>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–±–æ—Ä—â–∏–∫–∞ -->
    {% if not order.order.picker %}
    <div class="assignment-section">
        <form method="post" action="{% url 'warehouse:assign_picker' order.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-large">
                üõí –ü—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Å–±–æ—Ä–∫–µ
            </button>
            <small class="assignment-note">–í—ã –±—É–¥–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Å–±–æ—Ä—â–∏–∫–æ–º —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞</small>
        </form>
    </div>
    {% else %}
    <div class="picker-info">
        <p><strong>–°–±–æ—Ä—â–∏–∫:</strong> {{ order.order.picker.username }}</p>
    </div>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫–∞–∑–∞ -->
    <div class="order-items-section">
        <h2>–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</h2>

        <div class="items-list" id="itemsList">
            {% for item in order.items.all %}
            <div class="order-item" id="item-{{ item.id }}" data-item-id="{{ item.id }}">
                <div class="item-image">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                    {% else %}
                        <div class="no-image">üì¶</div>
                    {% endif %}
                </div>
                <div class="item-details">
                    <h3>{{ item.product.name }}</h3>
                    <p class="item-category">{{ item.product.category }}</p>
                    <div class="item-meta">
                        <div class="item-quantity">
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <strong>{{ item.quantity }} —à—Ç.</strong>
                        </div>
                        <div class="item-price">
                            –¶–µ–Ω–∞: {{ item.price }} ‚ÇΩ √ó {{ item.quantity }} = <strong>{{ item.get_cost }} ‚ÇΩ</strong>
                        </div>
                    </div>
                </div>

                <div class="item-actions">
                    {% if order.order.picker == request.user %}
                    <label class="toggle-collection">
                        <input type="checkbox" class="collection-checkbox" data-item-id="{{ item.id }}">
                        <span class="toggle-slider">
                            <span class="toggle-text">‚è≥ –°–æ–±—Ä–∞—Ç—å</span>
                        </span>
                    </label>
                    {% else %}
                    <div class="collection-status">
                        <span class="status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
    {% if order.order.picker == request.user %}
    <div class="completion-section">
        <form method="post" action="{% url 'warehouse:complete_order' order.id %}" id="completeForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-success btn-complete disabled" id="completeBtn" disabled>
                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É –∑–∞–∫–∞–∑–∞
            </button>
            <div class="completion-info">
                <span class="text-warning" id="completionText">
                    ‚ö† –°–æ–±—Ä–∞–Ω–æ <span id="collectedCount">0</span> –∏–∑ <span id="totalItems">{{ order.items.count }}</span> –ø–æ–∑–∏—Ü–∏–π
                </span>
            </div>
        </form>
    </div>
    {% endif %}

    {% endif %} <!-- –ö–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è –¥–ª—è –Ω–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->

</div>
{% endblock %}